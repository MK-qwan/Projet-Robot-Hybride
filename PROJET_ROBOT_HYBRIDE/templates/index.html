<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Dashboard | Premium Design</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === PALETTE N√âON ADOUCIE === */
        :root {
            --bg-dark: #0A0A0B;
            --card-dark: #141417;
            --button-bg: #1A1A1D;
            --text-light: #F0F0F0;
            --text-secondary: #888888;
            --accent-cyan: #00eaff;
            --accent-glow: rgba(0, 234, 255, 0.2);
            --danger-red: #ff4d4d;
            --danger-glow: rgba(255, 77, 77, 0.2);
            --border-radius-card: 16px;
            --border-radius-btn: 10px;
        }

        /* === GENERAL === */
        body {
            font-family: 'Inter', sans-serif; /* Remplacement de Comic Sans pour plus de coh√©rence Premium */
            background: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 50px 40px 90px 40px;
            line-height: 1.7;
            font-size: 15px;
        }

        /* === GRID === */
        .grid {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* === CARDS === */
        .card {
            background: var(--card-dark);
            border-radius: var(--border-radius-card);
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        h2 {
            color: var(--text-light);
            font-size: 1.4rem;
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* === VIDEO === */
        .video-box {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--border-radius-btn);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--accent-glow);
        }

        .live-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--danger-red);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 0 10px var(--danger-glow);
            z-index: 2;
        }

        /* === MODES DE COMMANDE (STYLE N√âON SOFT) === */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 35px;
        }

        .mode-grid button {
            width: 100%;
            padding: 18px 10px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            background: var(--button-bg);
            border: 1px solid rgba(0, 234, 255, 0.3);
            color: var(--accent-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-grid button:hover {
            background: rgba(0, 234, 255, 0.05);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px var(--accent-glow);
            transform: translateY(-2px);
        }

        .mode-grid button.active {
            background: var(--accent-cyan);
            color: #000;
            box-shadow: 0 0 25px var(--accent-glow);
        }

        /* === VOIX & PERSONNALIT√â === */
        .voice-selector-container {
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius-btn);
            background: rgba(255, 255, 255, 0.02);
        }

        .voice-selector-container summary {
            padding: 15px;
            cursor: pointer;
            color: var(--text-secondary);
            list-style: none;
            display: flex;
            justify-content: space-between;
        }

        .voice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .voice-grid button {
            padding: 10px;
            font-size: 0.85rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .voice-grid button:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        /* === VOCAL FEEDBACK === */
        #vocalFeedback {
            min-height: 60px;
            padding: 20px;
            margin-top: 25px;
            background: #000;
            border-left: 3px solid var(--accent-cyan);
            border-radius: 4px;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* === MANUAL PAD (SOMBRE & N√âON) === */
        .manual-pad {
            display: grid;
            grid-template-areas:
                ".    up    ."
                "left stop right"
                ".    down  .";
            gap: 12px;
            max-width: 200px;
            margin: 30px auto;
        }

        .manual-pad button {
            background: var(--button-bg);
            color: var(--accent-cyan);
            border: 1px solid rgba(0, 234, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            padding: 20px;
            font-size: 1.4rem;
            transition: 0.2s;
        }

        .manual-pad button:hover {
            background: rgba(0, 234, 255, 0.1);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .manual-pad .btn-stop-center {
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--danger-red);
            color: var(--danger-red);
            grid-area: stop;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .manual-pad .btn-stop-center:hover {
            background: var(--danger-red);
            color: white;
            box-shadow: 0 0 20px var(--danger-glow);
        }

        .manual-pad > button:nth-child(2) { grid-area: up; }
        .manual-pad > button:nth-child(4) { grid-area: left; }
        .manual-pad > button:nth-child(5) { grid-area: stop; }
        .manual-pad > button:nth-child(6) { grid-area: right; }
        .manual-pad > button:nth-child(8) { grid-area: down; }

        /* === EMERGENCY STOP === */
        .btn-stop-global {
            background: transparent;
            color: var(--danger-red);
            border: 2px solid var(--danger-red);
            font-size: 1.1rem;
            font-weight: bold;
            padding: 20px;
            width: 100%;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 20px;
        }

        .btn-stop-global:hover {
            background: var(--danger-red);
            color: white;
            box-shadow: 0 0 30px var(--danger-glow);
        }

        /* === CONFIG IP === */
        .config-row {
            display: flex;
            gap: 10px;
        }

        input {
            flex-grow: 1;
            background: #000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            padding: 12px;
            border-radius: 8px;
        }

        .config-row button {
            background: var(--accent-cyan);
            color: #000;
            font-weight: 700;
            padding: 0 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        /* === STATUS BAR === */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #050505;
            color: var(--text-secondary);
            padding: 15px 30px;
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        #videoStream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: rotate(180deg);
        }
    </style>
</head>

<body>

    <div class="grid">
        <div class="column-left">
            <div class="card">
                <h2>Vision du Robot</h2>
                <div class="video-box">
                    <span class="live-badge" id="liveBadge">LIVE</span>
                    <img id="videoStream" src="" alt="En attente de connexion...">
                </div>
            </div>

            <div class="card" style="margin-top: 30px;">
                <h2>Configuration IP</h2>
                <div class="config-row">
                    <input type="text" id="ipInput" placeholder="Adresse IP ESP32">
                    <button onclick="updateConfig()">D√©finir</button>
                </div>
            </div>
        </div>

        <div class="column-right">
            <div class="card">
                <h2>Modes de Commande</h2>
                
                <div class="mode-grid">
                    <button id="btn-MANUEL" onclick="setMode('MANUEL')">Manuel</button>
                    <button id="btn-AUTO_API" onclick="setMode('AUTO_API')">Auto Vision</button>
                    <button id="btn-VOCAL" onclick="setMode('VOCAL')">Vocal</button>
                </div>

                <details class="voice-selector-container">
                    <summary>üîä Changer la voix</summary>
                    <div class="voice-grid">
                        <button onclick="setConfig('voice', 'optimus')">Optimus Prime</button>
                        <button onclick="setConfig('voice', 'metal_sonic')">Metal Sonic</button>
                        <button onclick="setConfig('voice', 'chica')">Withered Chica</button>
                        <button onclick="setConfig('voice', 'texas')">Texas Instrument</button>
                    </div>
                </details>

                <div class="control-group" style="margin-top: 15px;">
                    <label style="color: var(--text-secondary); font-size: 0.8rem;">PERSONNALIT√â IA :</label>
                    <select id="personalitySelect" onchange="updateGlobalConfig()" style="width: 100%; padding: 12px; background: #000; color: white; border: 1px solid #333; border-radius: 8px; margin-top: 5px;">
                        <option value="SOLDAT">ü™ñ Soldat (Disciplin√©)</option>
                        <option value="SARCASTIQUE">ü§° Sarcastique (Troll)</option>
                        <option value="PIRATE">PIRATE</option>
                        <option value="RICHARD">RICHARD WATTERSON (PARESSEUX)</option>
                        <option value="AM">AM (IA HOSTILE)</option>
                        <option value="FATHER">FATHER</option>
                        <option value="GLADOS">Glados</option>
                        <option value="PRIDE">PRIDE</option>
                    </select>
                </div>

                <div id="vocalFeedback">
                    Dialogue en attente...
                </div>

                <div class="manual-pad">
                    <div></div>
                    <button onmousedown="manualCtrl('fwd')" onmouseup="manualCtrl('stop')">‚ñ≤</button>
                    <div></div>
                    <button onmousedown="manualCtrl('turnLeft')" onmouseup="manualCtrl('stop')">‚óÑ</button>
                    <button class="btn-stop-center" onmousedown="manualCtrl('stop')">STOP</button>
                    <button onmousedown="manualCtrl('turnRight')" onmouseup="manualCtrl('stop')">‚ñ∫</button>
                    <div></div>
                    <button onmousedown="manualCtrl('bwd')" onmouseup="manualCtrl('stop')">‚ñº</button>
                    <div></div>
                </div>
            </div>

            <div class="emergency-stop">
                <button class="btn-stop-global" onclick="setMode('stop')">ARR√äT D'URGENCE</button>
            </div>
        </div>
    </div>

    <div class="status-bar" id="statusInfo">
        Initialisation du syst√®me...
    </div>

    <script>
        let currentIP = "";

        // GESTION CLAVIER
        document.addEventListener('keydown', function (event) {
            if (document.activeElement.tagName === 'INPUT') return;
            if (event.repeat) return;
            let action = null;
            switch (event.key) {
                case 'ArrowUp': action = 'fwd'; break;
                case 'ArrowDown': action = 'bwd'; break;
                case 'ArrowLeft': action = 'turnLeft'; break;
                case 'ArrowRight': action = 'turnRight'; break;
                case ' ': action = 'stop'; break;
                default: return;
            }
            event.preventDefault();
            if (action === 'stop') setMode('stop');
            else manualCtrl(action);
        });

        document.addEventListener('keyup', function (event) {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                manualCtrl('stop');
            }
        });

        function setConfig(key, value) {
            let data = {};
            data[key] = value;
            fetch('/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        function updateGlobalConfig() {
            const ip = document.getElementById('ipInput').value;
            const personality = document.getElementById('personalitySelect').value;
            fetch('/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip: ip, personality: personality })
            });
        }
        
        function updateConfig() { updateGlobalConfig(); }

        function setMode(mode) {
            if (mode === 'stop') {
                fetch('/control/stop', { method: 'POST' });
                fetch('/set_mode/MANUEL', { method: 'POST' });
                alert("üõë ARR√äT D'URGENCE");
            } else {
                fetch('/set_mode/' + mode, { method: 'POST' });
            }
        }

        function manualCtrl(action) {
            fetch('/control/' + action, { method: 'POST' });
        }

        function updateStatus() {
            fetch('/status')
                .then(r => r.json())
                .then(data => {
                    const videoStreamElement = document.getElementById('videoStream');
                    const liveBadge = document.getElementById('liveBadge');
                    const vocalFeedback = document.getElementById('vocalFeedback');
                    const cyanColor = "#00eaff";

                    document.querySelectorAll('.mode-grid button').forEach(b => b.classList.remove('active'));
                    const activeBtn = document.getElementById('btn-' + data.mode);
                    if (activeBtn) activeBtn.classList.add('active');
                    
                    if(data.personality) document.getElementById('personalitySelect').value = data.personality;

                    const vocalBtn = document.getElementById('btn-VOCAL');
                    const lastLog = data.logs.slice().reverse().find(l => ['VOCAL', 'GEMINI', 'VISION'].includes(l.source));

                    if (data.mode === 'VOCAL') {
                        vocalBtn.innerText = "üé§ √âCOUTE...";
                        if (lastLog) {
                            vocalFeedback.innerHTML = `<span style="color:${cyanColor}">${lastLog.source}</span>: ${lastLog.msg}`;
                        }
                    } else {
                        vocalBtn.innerText = "Vocal";
                        vocalFeedback.innerHTML = "Dialogue en attente...";
                    }

                    if (data.ip !== currentIP) {
                        currentIP = data.ip;
                        if(currentIP) document.getElementById('ipInput').value = currentIP.replace("http://", "");
                    }

                    if (data.latest_image && data.mode === 'AUTO_API') {
                        videoStreamElement.src = 'data:image/jpeg;base64,' + data.latest_image;
                        liveBadge.innerText = "SNAPSHOT IA";
                        liveBadge.style.backgroundColor = cyanColor;
                    } else if(currentIP) {
                        videoStreamElement.src = currentIP + "/capture?t=" + new Date().getTime();
                        liveBadge.innerText = "LIVE FEED";
                        liveBadge.style.backgroundColor = "#ff4d4d";
                    }

                    const lastMsg = data.logs.length > 0 ? data.logs[data.logs.length - 1].msg : 'Pr√™t';
                    document.getElementById('statusInfo').innerHTML = 
                        `MODE: <strong style="color:${cyanColor}">${data.mode}</strong> | PERSO: ${data.personality} | LOG: ${lastMsg}`;
                })
                .catch(e => {
                    document.getElementById('statusInfo').innerHTML = "‚ö†Ô∏è Connexion Serveur Perdue...";
                });
        }

        setInterval(updateStatus, 1000);
        updateStatus();
    </script>
</body>
</html>